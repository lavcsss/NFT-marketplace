<% is_collection_owner = @collection.is_owner?(current_user) %>
<%= hidden_field_tag 'collection_id', @collection.address %>
<%= hidden_field_tag 'is_collection_lazy_minted', @collection.is_lazy_minted? %>
<span hidden="hidden" id="fiat-payment-validate"> </span>
<span hidden="hidden" id="contract_address">  <%= @collection.nft_contract&.address %> </span> 
<span id="eth_balance" class="curEthBalance hide">0.0</span>
<span id="erc20_balance" class="curErc20Balance hide">0.0</span>
<span id="BuyerserviceFee" class="hide"><%= buyer_service_fee %></span>
<span id="SellerserviceFee" class="hide"><%= seller_service_fee %></span>
<span id="contractType" class="hide"><%= @collection.nft_contract&.contract_type %></span>
<span id="contractAddress" class="hide"><%= @collection.nft_contract&.address %></span>
<span hidden="hidden" id="collection_id">  <%= @collection.id %> </span> 
<span hidden="hidden" id="is_eth_payment" is_eth_payment="<%= @collection.is_eth_payment %>"> </span> 
<%= hidden_field_tag 'collection_ismultiple', @collection.multiple? %>
<% unless @collection.is_eth_payment %>
<%= hidden_field_tag 'buyContractAddress', @collection.erc20_token.address %>
<%= hidden_field_tag 'buyContractDecimals', @collection.erc20_token.decimals %>
<% end %>
<div class="collection-page">
   <header style="padding: 12px 30px;
      margin: 0;
      background-color: #fff;
      height: 50px;
      list-style: none;
      display: flex;
      align-items: center;
      margin: 0 auto; width: 100%; margin-bottom: 50px;">
   </header>
   <section class="profile-section">
      <div class="container">
         <div class="row">
            <div class="col-sm-12">
               <p>
                  <%= @collection.title %><br>
                  <% if @collection.single? %>
                  <span>Editions: <b><%= @collection.total_copies %></b></span>
                  <% else %>
                  <span>Editions: <b><%= @collection.total_copies %></b></span>
                  <% end %>
               </p>
               <div class="modal-more-options">
                  <a class="more_action_btn" href="javascript:void(0);" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                     <img src="../../assets/nft/share-black.svg">
                  </a>
                  <ul class="dropdown-menu header__profile-menu" aria-labelledby="dropdownMenuProfile">
                     <li><a target=_blank href="https://www.facebook.com/sharer/sharer.php?u=<%= current_url %>&caption=<%= @collection.name %>&description=<%= @collection.description %>" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                        <i class="fa fa-facebook"></i><span>Facebook</span>
                        </a>
                     </li>
                     <li><a target=_blank href="https://twitter.com/share?url=<%= current_url %>&text=<%= @collection.name %>, <%= @collection.description %>" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                        <i class="fa fa-twitter"></i><span>Twitter</span>
                        </a>
                     </li>
                     <li><a target=_blank href="https://telegram.me/share/url?url=<%= current_url %>&text=<%= @collection.name %>, <%= @collection.description %>" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                        <i class="fa fa-telegram"></i><span>Telegram</span>
                        </a>
                     </li>
                     <li><a target=_blank href="mailto:?subject=<%= @collection.name %>&body=<%= @collection.description %> Link here:<%= current_url %>">
                        <i class="fa fa-envelope"></i><span>Email</span>
                        </a>
                     </li>
                  </ul>
                  <%= react_component("collections/like", address: current_user&.address, likes: @collection.likes, collectionId: @collection.id, 
                     liked: @collection.is_liked_by_me(current_user&.id)) %>
                  <% if current_user && @collection.is_owner?(current_user) %>
                     <div class="more_action_block">
                        <a class="more_action_btn" href="javascript:void(0);" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">               
                           <div class="option-btn">
                              <span></span>
                              <span></span>
                              <span></span>
                           </div>
                        </a>
                        <ul class="dropdown-menu header__profile-menu" aria-labelledby="dropdownMenuProfile">
                           <% if current_user && current_user.is_approved? %>
                              <% if @collection.put_on_sale? %>
                              <li><a href="javascript:void(0)" onclick="window.show_modal('#removeSaleModal')"><%= t('collections.show.remove_from_sale')%></a></li>
                              <% else %>
                              <li><a href="javascript:void(0)" class="change-price" onclick="window.show_modal('#change-price')"><%= t('shared.put_on_sale')%></a></li>
                              <% end %>
                              <li><a href="javascript:void(0)" class="change-price" onclick="window.show_modal('#change-price')" ><%= t('collections.show.change_price')%></a></li>
                              <%if !@collection.is_lazy_minted? %>
                                 <li><a href="javascript:void(0)"  class="transfer-token" onclick="window.show_modal('#transferTokenForm')" ><%= t('collections.show.transfer_token')%></a></li>
                                 <li><%= link_to "Burn token", 'javascript:void(0)', 'onclick': "window.show_modal('#burnModal')" %></li>
                              <% end %>
                           <% else %>
                              <% if @collection.put_on_sale? %>
                                 <li><a href="" class="show-login-message"><%= t('collections.show.remove_from_sale')%></a></li>
                              <% else %>
                                 <li><a href="javascript:void(0)" class="show-login-message change-price"><%= t('shared.put_on_sale')%></a></li>
                              <% end %>
                              <li><a href="javascript:void(0)" class="show-login-message change-price" ><%= t('collections.show.change_price')%></a></li>
                              <%if !@collection.is_lazy_minted? %> 
                                 <li><a href="javascript:void(0)"  class="show-login-message transfer-token" ><%= t('collections.show.transfer_token')%></a></li>
                                 <li><a href="javascript:void(0)"  class="show-login-message" ><%= t('collections.show.burn_token')%></a></li>
                              <% end %>
                           <% end %>
                        </ul>
                     </div>
                     <div class="more_action_block">
                        <a class="more_action_btn">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                        </a>
                     </div>
                  <%end%>
               </div>
         </div>
      </div>
      <div class="container">
         <div class="row">
            <div class="col-md-6" >
               <div class="profile-box">
                  <% if ['audio/mp3', 'audio/webm', 'audio/mpeg'].include?(@collection.attachment.content_type)  %>
                  <span class="collection-card-img audio_tag" style="background-image: url('<%= cover_url(@collection) %>')">
                  <%= attachment_tag(@collection) %>
                  </span>
                  <%elsif ['video/mp4', 'video/webm'].include?(@collection.attachment.content_type)%>
                   <%= attachment_tag(@collection) %>
                  <% else %>
                  <img src="<%= url_for(@collection.attachment) %>" class="img-responsive">
                  <% end %>
               </div>
            </div>
            <div class="col-md-6" >
               <div class="des-box">
                  <div class="des-box-2">
                     <% if @collection.description.present? %>
                        <p>Description</p>
                        <% if @collection.description.length > 170 %>
                        <span class="textControl"><%= @collection.description %></span> 
                        <% else %>
                        <span><%= @collection.description %></span> 
                        <% end %>
                     <% end %>
                  </div>
                  <div class="creater-div">
                     <div class="left-div">
                        <div class="pro-div-2"><span>Creator</span></div>
                        <div class="pro-div">
                           <%= image_tag @collection.creator.profile_image %>
                        </div>
                        <div class="user-detail">
                           <p><%= link_to @collection.creator.full_name, user_path(@collection.creator.address)%></p>
                        </div>
                     </div>
                     <div class="left-div">
                        <div class="pro-div-2"> <span>Collection</span></div>
                        <div class="pro-div">
                           <% if @collection.nft_contract.attachment_url.present? %>
                           <%= image_tag @collection.nft_contract.attachment_url %>
                           <% else %>
                           <%= image_tag "image-4.jpg" %>
                           <% end %>
                        </div>
                        <div class="user-detail">
                           <% if @collection.own_collection.present? %>
                           <p><a href="<%=nft_contract_path(@collection.collection_address)%>"><%= @collection.contract_name %></a></p>
                           <% else %>                    
                           <p><a><%= @collection.collection_info_name %></a></p>
                           <% end %>
                        </div>
                     </div>
                     <% if @collection.royalty && @collection.royalty > 0 %>
                     <div class="roy-box"><%= @collection.royalty %>% of resale royalty</div>
                     <% end %>
                     <div class="clear"></div>
                  </div>
                  <div class="bolck-div">
                     <div class="row">
                        
                           <div class="col-sm-6 col-xs-6">
                           <p><span>Highest Bid</span></p>
                              <% if @max_bid %>
                              <p><%= @max_bid.value %> for <%= @max_bid.quantity %> edition(s)</p>
                              <% else %>
                              <p>No bids</p>
                              <% end %>
                           <% if not is_collection_owner %>
                              <% if current_user && current_user.is_approved? %>
                                 <div class="spce-div"> <a href="javascript:void(0)" onClick="window.show_modal('#Bid-modal')" class="bolck-div-button bid-now">Make a offer</a></div>
                              <% else %>
                                 <div class="spce-div"> <a href="javascript:void(0)" class="bolck-div-button button-no-user">Make a offer</a></div>
                              <% end %>
                           <% end %>
                           </div>
                           <div class="col-sm-6 col-xs-6">
                           <% if @collection.instant_sale_enabled? && @collection.instant_sale_price.present? %>
                           <p><span>Sale Price</span></p>
                           <p><%= @collection.instant_sale_price%> <%= @collection.collection_coin %></p>
                              <% if not is_collection_owner %>
                                 <% if current_user && current_user.is_approved? %>
                                    <% if @collection.owner.address == @collection.creator.address && show_fiat_buy_option(@collection) %>
                                    <div class="spce-div"> <a href="javascript:void(0)" onclick="window.show_modal('#Payment-modal', false)" class="bolck-div-button-2 buy-now">Buy for <%= @collection.instant_sale_price%> <%= @collection.collection_coin %></a></div>
                                    <% else %>
                                    <div class="spce-div"> <a href="javascript:void(0)" onclick="window.show_modal('#Buy-modal', false)" class="bolck-div-button-2 buy-now">Buy for <%= @collection.instant_sale_price%> <%= @collection.collection_coin %></a></div>
                                    <% end %>
                                 <% else %>
                                    <div class="spce-div"> <a href="" class="bolck-div-button-2 button-no-user">Buy for <%= @collection.instant_sale_price%> <%= @collection.collection_coin %></a></div>
                                 <% end %>
                              <% end %>
                           <% end %>
                           </div>
                        
                     </div>
                  </div>
               </div>
               <div class="tabs">
                  <input type="radio" name="tabs" id="tabone" checked="checked">
                  <label for="tabone">Bids</label>
                  <div class="tab">
                     <% if @collection.bids.pending.present? %>
                        <% @collection.bids.by_desc.pending.each do |bid| %>
                        <table>
                           <tr>
                              <td>
                                 <div class="tab-img-box"><%= image_tag url_for(bid.user.profile_image)%></div>
                              </td>
                              <td>
                                 <p><%=bid.crypto_currency%> <%=bid.crypto_currency_type%> by <%= link_to bid.user.full_name, user_path(bid.user.address)%> </p>
                                 <span><%= time_ago_in_words(bid.created_at) %> ago</span>
                              </td>
                              <%if is_collection_owner %>
                                 <td>
                                    <div class="spce-div">
                                    <%= link_to 'Execute', 'javascript:void(0)', class: "bolck-div-button-2 execute-btn execButton", bidId: bid.id, price: bid.amount, qty: bid.quantity, bidUser: bid.user.full_name, bidDetail: bid.desc, bidSymbol: bid.erc20_token&.symbol, erc20ContractAddress: bid.erc20_token&.address, nftContractAddress: bid&.collection&.nft_contract&.address %>
                                    </div>
                                 </td>
                              <%end%>
                           </tr>
                        </table>
                        <% end %>
                     <% else %>
                        <table>
                           <tr>
                           <td>
                              <p> No bids Available </p>
                           </td>
                           </tr>
                        </table>
                     <% end %>
                  </div>
                  <input type="radio" name="tabs" id="tabtwo">
                  <label for="tabtwo">History</label>
                  
                  <%= render partial: 'history' %>

                  <!-- <input type="radio" name="tabs" id="tabthree">
                  <label for="tabthree">Properties</label>
                  <div class="tab">
                     <div class="tab-porp-box">
                        <p class="align-right">(10/1000)</p>
                        <p>Accessory</p>
                        <span>Front Beard Dark</span>
                     </div>
                     <div class="tab-porp-box">
                        <p class="align-right">(10/1000)</p>
                        <p>Accessory</p>
                        <span>Front Beard Dark</span>
                     </div>
                     <div class="tab-porp-box">
                        <p class="align-right">(10/1000)</p>
                        <p>Accessory</p>
                        <span>Front Beard Dark</span>
                     </div>
                  </div>-->
                  <input type="radio" name="tabs" id="tabfour">
                  <label for="tabfour">Details</label>
                  <div class="tab">
                     <div class="details-box">
                        <span>Owner</span>
                        <p><%= link_to @collection.owner.full_name, user_path(@collection.owner.address)%></p>
                     </div>
                     <div class="details-box">
                        <span>Minted On</span>
                        <p><%=@collection.created_at.strftime("%b %d, %Y")%></p>
                     </div>
                     <div class="details-box">
                        <span>Available Editions</span>
                        <p><%= @collection.total_copies %></p>
                     </div>
                     <div style="clear:both;"></div>
                     <div class="add-div">
                        <p>Contract Address</p>
                        <%=@collection.contract_address%>
                        <span hidden="hidden" id="address"> 
                        <%= @collection.contract_address %> </span> 
                        <img src="../../assets/nft/modeling/copy.png" class="copy_address" style="width: 20px;cursor: pointer;">
                     </div>
                     <a target="_blank" href="<%= "https://ipfs.io/ipfs/#{@collection.image_hash}" %>">
                        <div class="tab-button"><img src="../../assets/landing_page/ipfs-box.svg"> IPFS </div>
                     </a>
                     <% if @collection.transaction_hash.present? %>
                     <a target="_blank" href="<%= "#{Rails.application.credentials.config[:etherscan_url]}/tx/#{@collection.transaction_hash}" %>">
                        <div class="tab-button"><img src="../../assets/landing_page/eth.svg"> Etherscan </div>
                     </a>
                     <% end %>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </section>
</div>
<%= render partial: 'collections/price_change' %>
<%= render partial: 'collections/token_transfer' %>
<%= render partial: 'collections/bid_modal' %>
<%= render partial: 'collections/burn_modal' %>
<%= render partial: 'collections/remove_sale_modal' %>
<% if is_collection_owner %>
<%= render partial: 'collections/execute_bid' %>
<% end %>
<%= render partial: 'collections/payment_modal' %>

<script type="text/javascript">
   $(document).ready(function(){
      $(".button-no-user").click(function(){  
         toastr.error('Please connect your wallet to proceed.');
      })
   }
   );
   
   $(document).ready(function () {
    $("#bid_amt, #bid_currency, #bid_qty").on('input', function () {
      calculateBid($('#BuyerserviceFee').text());
    });
    
    $("#buy_qty").on('input', function () {
      calculateBuy($('#BuyerserviceFee').text());
    });

    $(".mul_buy_inp").on('input', function () {
      $(".loading-gif").show();
         setTimeout(function(){
            calculateBuyFiatAmt();
            $(".loading-gif").hide();
         }, 500);
    });
   
    <% if @collection.single? %>
      $(".buy-now").on('click', function (e) {
        e.preventDefault();
        $("#buy_qty").val(1);
        calculateBuy($('#BuyerserviceFee').text());
      });
    <% end %>
   
   <% if @collection.single? %>
      $(".calculate_price").click(function(){
         $(".loading-gif").show();
         setTimeout(function(){
            calculateBuyFiatAmt();
            $(".loading-gif").hide();
         }, 100);
      })
   <% end %>

    window.calculateBuyFiatAmt = function calculateBuyFiatAmt(){
      <% if @collection.single? %>
         var qty = $('#buy_qty').val().replace(/[^0-9]/g, '') || 1;
      <% else %>
         var qty = $('#buy_qty').val().replace(/[^0-9]/g, '') || 0;
      <% end %>
      if (qty != 0) {
         $.ajax({
            url: '/collections/' + $('#collection_id').val() + '/total_fiat_price',
            type: 'GET',
            async: false,
            data: {"quantity": qty},
            success: function (respVal) {
            resp = respVal['data']
            }
         });
         $("#total-fiat-price").html('$ ' + numToString(resp));
      }else{
         $("#total-fiat-price").html('$ 0.00');
      }
    }
   
    $(document).on("change", "#collection-put-on-sale", function () {
      if (!$(this).is(":checked")) {
        $('#collection_instant_sale_enabled').prop("checked", false).change();
        $('#collection-unlock-on-purchase').prop("checked", false).change();
      }
    })
   
    $(document).on("change", "#collection_instant_sale_select", function () {
      if ($(this).is(":checked")) {
        $("#instant-price").closest(".row").removeClass("hide")
      } else {
        $("#instant-price").closest(".row").addClass("hide")
      }
    });
   
    $(document).on("change", "#collection-unlock-on-purchase", function () {
      if ($(this).is(":checked")) {
        $(".unlock-description-section").removeClass("hide")
      } else {
        $(".unlock-description-section").addClass("hide")
      }
    });
   
    <%if params[:act]%>
      window.show_modal('#<%=params[:act]%>')
    <%end%>
   
    $('a[data-dismiss="modal"]').on('click', function(e) {
      e.preventDefault();
      $.magnificPopup.close();
    });
   
   });
   
   function openCity(evt, cityName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(cityName).style.display = "block";
      evt.currentTarget.className += " active";
      if (cityName == 'History'){
         updateHistory()
      }
   }

   function updateHistory() {
      var collectionId = $("#collection_id").val();
      var request = $.ajax({
         url: `/collections/${collectionId}/history`,
         type: "GET",
         async: false,
         dataType: "script"
      });
   }
  
   $('.expand-btn').click(function() {
         var src = $('img[data-enlargeable]').attr('src');
         var modal;
         var close_tag;
         modal = $('<div>').css({
            background: 'RGBA(0,0,0,.5)',
            width: '100%',
            height: '100%',
            position: 'fixed',
            zIndex: '10000',
            top: '0',
            left: '0',
            cursor: true, 
         }).addClass("enlarged-bg").appendTo('body');
         image_tag =  "<img src=" + src + " class='enlarged-img'/> <div class='expand-btn minimize-btn'> <img src='../../assets/nft/minimize.svg' /> </div>"
         $(".enlarged-bg").append(image_tag);
         

         function removeModal() {
            modal.remove();
            $('body').off('keyup.modal-close');
         }

         $(document).mouseup(e => {
            if ($('div').is(e.target) || $('.minimize-btn').click())
            {
               removeModal();
            }
         })
   });

   function validateFiatPayment() {
    <%if params[:token].present? %>  
      $("#fiat-payment-validate").click()
    <% end %>
   }
   window.onload = validateFiatPayment;
   
  
   
</script>